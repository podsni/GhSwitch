name: Create Release Draft

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0 - without v prefix)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

jobs:
  create-release-draft:
    name: Create Release Draft
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Create Git tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "v${{ github.event.inputs.version }}" -m "Release v${{ github.event.inputs.version }}"
        git push origin "v${{ github.event.inputs.version }}"

    - name: Build all platform binaries
      run: |
        echo "ğŸ”¨ Building GhSwitch v${{ github.event.inputs.version }} for all platforms..."
        mkdir -p build
        
        # Build for Linux x64
        echo "ğŸ§ Building for Linux x64..."
        bun build --compile --target=bun-linux-x64 --minify --sourcemap --outfile build/ghswitch ./index.ts
        
        # Build for Linux ARM64
        echo "ğŸ§ Building for Linux ARM64..."
        bun build --compile --target=bun-linux-arm64 --minify --sourcemap --outfile build/ghswitch-linux-arm64 ./index.ts
        
        # Build for Windows x64
        echo "ğŸªŸ Building for Windows x64..."
        bun build --compile --target=bun-windows-x64 --minify --sourcemap --outfile build/ghswitch.exe ./index.ts
        
        # Build for macOS x64
        echo "ğŸ Building for macOS x64..."
        bun build --compile --target=bun-darwin-x64 --minify --sourcemap --outfile build/ghswitch-macos ./index.ts
        
        # Build for macOS ARM64
        echo "ğŸ Building for macOS ARM64..."
        bun build --compile --target=bun-darwin-arm64 --minify --sourcemap --outfile build/ghswitch-macos-arm64 ./index.ts
        
        echo "âœ… All builds completed!"

    - name: Generate checksums
      run: |
        echo "ğŸ“Š Generating checksums..."
        cd build
        sha256sum * > ../checksums.txt
        cd ..
        cat checksums.txt

    - name: Get current date
      id: date
      run: echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

    - name: Create Release Draft
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.event.inputs.version }}
        name: GhSwitch v${{ github.event.inputs.version }}
        body: |
          # ğŸ‰ GhSwitch v${{ github.event.inputs.version }}
          
          **Beautiful GitHub Account Switcher - Standalone Binaries**
          
          Released on ${{ steps.date.outputs.date }}
          
          ## ğŸ“¦ Downloads
          
          Choose the appropriate binary for your platform:
          
          | Platform | Binary | Size |
          |----------|--------|------|
          | ğŸ§ **Linux x64** | [`ghswitch`](https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/ghswitch) | ~100MB |
          | ğŸ§ **Linux ARM64** | [`ghswitch-linux-arm64`](https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/ghswitch-linux-arm64) | ~93MB |
          | ğŸªŸ **Windows x64** | [`ghswitch.exe`](https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/ghswitch.exe) | ~114MB |
          | ğŸ **macOS Intel** | [`ghswitch-macos`](https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/ghswitch-macos) | ~64MB |
          | ğŸ **macOS Apple Silicon** | [`ghswitch-macos-arm64`](https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/ghswitch-macos-arm64) | ~58MB |
          
          ## ğŸš€ Quick Installation
          
          ### One-line installation:
          ```bash
          curl -fsSL https://raw.githubusercontent.com/podsni/GhSwitch/main/install.sh | bash
          ```
          
          ### Manual installation:
          ```bash
          # Download binary for your platform
          wget https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/ghswitch
          
          # Make executable
          chmod +x ghswitch
          
          # Run
          ./ghswitch
          ```
          
          ### Global installation:
          ```bash
          # Linux/macOS
          sudo cp ghswitch /usr/local/bin/
          
          # Windows (as Administrator)
          copy ghswitch.exe C:\Windows\System32\
          ```
          
          ## âœ¨ What's New in v${{ github.event.inputs.version }}
          
          <!-- Add changelog items here -->
          - âœ¨ Beautiful terminal UI with Charm-inspired design
          - ğŸ”„ Multi-account GitHub switching per repository
          - ğŸ” Dual authentication: SSH keys and Personal Access Tokens
          - ğŸ¯ Active account detection with visual indicators
          - ğŸ§ª Connection testing for GitHub connectivity
          - âš¡ Zero dependencies - single executable file
          - ğŸ–¥ï¸ Cross-platform support (Linux, Windows, macOS)
          
          ## ğŸ“‹ Usage Examples
          
          ```bash
          # Start GhSwitch
          ./ghswitch
          
          # Navigate through the beautiful menu:
          # â• Add account       - Add new GitHub account
          # ğŸ”„ Switch account    - Switch account for current repo
          # ğŸ§ª Test connection   - Test GitHub connectivity
          # ğŸ“‹ List accounts     - View all configured accounts
          # ğŸ”‘ Generate SSH key  - Create new SSH key
          # ğŸ“¥ Import SSH key    - Import existing SSH key
          # âœï¸  Edit account     - Modify account settings
          # ğŸ—‘ï¸  Remove account   - Delete account configuration
          ```
          
          ## ğŸ”§ Verification
          
          Verify download integrity using checksums:
          ```bash
          # Download checksums
          wget https://github.com/podsni/GhSwitch/releases/download/v${{ github.event.inputs.version }}/checksums.txt
          
          # Verify
          sha256sum -c checksums.txt
          ```
          
          ## ğŸ“š Documentation
          
          - [ğŸ“– Complete Documentation](https://github.com/podsni/GhSwitch/blob/main/README.md)
          - [ğŸ“¦ Distribution Guide](https://github.com/podsni/GhSwitch/blob/main/DISTRIBUTION.md)
          - [ğŸ”§ Build Instructions](https://github.com/podsni/GhSwitch/blob/main/BUILD_SUMMARY.md)
          
          ## ğŸ› Issues & Support
          
          Found a bug or need help? [Open an issue](https://github.com/podsni/GhSwitch/issues)
          
          ---
          
          **Full Changelog**: https://github.com/podsni/GhSwitch/compare/v1.0.0...v${{ github.event.inputs.version }}
        draft: true
        prerelease: ${{ github.event.inputs.prerelease }}
        files: |
          build/ghswitch
          build/ghswitch-linux-arm64
          build/ghswitch.exe
          build/ghswitch-macos
          build/ghswitch-macos-arm64
          checksums.txt
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Output release info
      run: |
        echo "âœ… Release draft created successfully!"
        echo "ğŸ“¦ Version: v${{ github.event.inputs.version }}"
        echo "ğŸ”— Release URL: https://github.com/podsni/GhSwitch/releases/tag/v${{ github.event.inputs.version }}"
        echo ""
        echo "ğŸ“ Next steps:"
        echo "1. Review the release draft on GitHub"
        echo "2. Edit the changelog if needed"
        echo "3. Publish the release when ready"
